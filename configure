#!/bin/bash

# libcsvkit Build Configuration Script
# Copyright (C) 2025 AnmiTaliDev <anmitali198@gmail.com>

set -e

# Color codes
RESET='\033[0m'
BOLD='\033[1m'
DIM='\033[2m'

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'

BOLD_RED='\033[1;31m'
BOLD_GREEN='\033[1;32m'
BOLD_YELLOW='\033[1;33m'
BOLD_BLUE='\033[1;34m'
BOLD_CYAN='\033[1;36m'

# Configuration defaults
PREFIX="/usr/local"
LIBDIR=""
INCLUDEDIR=""
CC="gcc"
CXX="g++"
AR="ar"
CFLAGS="-Wall -Wextra -Wpedantic -std=c99 -fPIC"
CXXFLAGS="-Wall -Wextra -Wpedantic -std=c++11 -fPIC"
LDFLAGS="-shared"
BUILD_TYPE="Release"
ENABLE_DEBUG="OFF"
ENABLE_VERBOSE="OFF"
ENABLE_STATIC="ON"
ENABLE_SHARED="ON"
ENABLE_EXAMPLES="ON"
ENABLE_CPP="OFF"
SRC_DIR="src"
INC_DIR="include"
BUILD_DIR="build"
LIB_DIR="lib"
EXAMPLE_DIR="examples"
CPP_DIR="extras/cpp"

# Version
VERSION_MAJOR=0
VERSION_MINOR=1
VERSION_PATCH=0
VERSION="${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_PATCH}"

# Detection results
CC_VERSION=""
CC_PATH=""
CXX_VERSION=""
CXX_PATH=""
AR_PATH=""
PLATFORM=""
ARCH=""

# Helper Functions

print_header() {
    echo
    echo -e "${BOLD_CYAN}$1${RESET}"
    echo
}

print_section() {
    echo -e "${BOLD}-- $1${RESET}"
}

print_status() {
    local status=$1
    local message=$2
    if [ "$status" = "OK" ]; then
        echo -e "   ${BOLD_GREEN}[OK]${RESET} ${message}"
    elif [ "$status" = "WARN" ]; then
        echo -e "   ${BOLD_YELLOW}[WARN]${RESET} ${message}"
    elif [ "$status" = "ERROR" ]; then
        echo -e "   ${BOLD_RED}[ERROR]${RESET} ${message}"
    elif [ "$status" = "INFO" ]; then
        echo -e "   ${BOLD_BLUE}[INFO]${RESET} ${message}"
    fi
}

print_config() {
    local key=$1
    local value=$2
    printf "   ${BOLD}%-25s${RESET} : ${CYAN}%s${RESET}\n" "$key" "$value"
}

print_error() {
    echo
    echo -e "${BOLD_RED}ERROR: $1${RESET}"
    echo
    exit 1
}

# Help Message

show_help() {
    cat << EOF
${BOLD}libcsvkit Configuration Script${RESET}

${BOLD}USAGE:${RESET}
    ./configure [OPTIONS]

${BOLD}OPTIONS:${RESET}
    --prefix=PREFIX           Installation prefix (default: /usr/local)
    --libdir=DIR             Library installation directory (default: PREFIX/lib)
    --includedir=DIR         Header installation directory (default: PREFIX/include)
    --cc=PATH                Path to C compiler (default: gcc)
    --cxx=PATH               Path to C++ compiler (default: g++)
    --ar=PATH                Path to archiver (default: ar)
    --build-type=TYPE        Build type: Release, Debug (default: Release)
    --enable-debug           Enable debug symbols in Release build
    --enable-verbose         Enable verbose compilation output
    --enable-cpp             Enable C++ bindings
    --disable-static         Disable building static library
    --disable-shared         Disable building shared library
    --disable-examples       Disable building examples
    --help                   Show this help message

${BOLD}BUILD TYPES:${RESET}
    Release                  Optimized build with -O2 flags
    Debug                    Debug build with -g -O0 flags

${BOLD}EXAMPLES:${RESET}
    ./configure
    ./configure --prefix=/usr --build-type=Debug
    ./configure --cc=clang --enable-verbose
    ./configure --disable-static --enable-debug
    ./configure --build-type=Release --enable-debug

${BOLD}AFTER CONFIGURATION:${RESET}
    make                     Build the library
    make examples            Build example programs
    make install             Install library and headers
    make clean               Remove build artifacts

EOF
    exit 0
}

# Argument Parsing

parse_arguments() {
    for arg in "$@"; do
        case $arg in
            --prefix=*)
                PREFIX="${arg#*=}"
                ;;
            --libdir=*)
                LIBDIR="${arg#*=}"
                ;;
            --includedir=*)
                INCLUDEDIR="${arg#*=}"
                ;;
            --cc=*)
                CC="${arg#*=}"
                ;;
            --cxx=*)
                CXX="${arg#*=}"
                ;;
            --ar=*)
                AR="${arg#*=}"
                ;;
            --build-type=*)
                BUILD_TYPE="${arg#*=}"
                ;;
            --enable-debug)
                ENABLE_DEBUG="ON"
                ;;
            --enable-verbose)
                ENABLE_VERBOSE="ON"
                ;;
            --enable-cpp)
                ENABLE_CPP="ON"
                ;;
            --disable-static)
                ENABLE_STATIC="OFF"
                ;;
            --disable-shared)
                ENABLE_SHARED="OFF"
                ;;
            --disable-examples)
                ENABLE_EXAMPLES="OFF"
                ;;
            --help)
                show_help
                ;;
            *)
                print_error "Unknown option: $arg (use --help for usage)"
                ;;
        esac
    done

    if [ -z "$LIBDIR" ]; then
        LIBDIR="$PREFIX/lib"
    fi

    if [ -z "$INCLUDEDIR" ]; then
        INCLUDEDIR="$PREFIX/include"
    fi
}

# System Detection

detect_system() {
    print_section "Detecting System Configuration"

    if [ "$(uname -s)" = "Linux" ]; then
        PLATFORM="Linux"
    elif [ "$(uname -s)" = "Darwin" ]; then
        PLATFORM="macOS"
    elif [ "$(uname -s)" = "FreeBSD" ]; then
        PLATFORM="FreeBSD"
    else
        PLATFORM="$(uname -s)"
    fi
    print_status "OK" "Platform: ${PLATFORM}"

    ARCH="$(uname -m)"
    print_status "OK" "Architecture: ${ARCH}"
    echo
}

# Compiler Detection

detect_compiler() {
    print_section "Checking for C Compiler"

    if ! command -v "$CC" &> /dev/null; then
        print_status "ERROR" "C compiler not found: $CC"
        print_error "Please install gcc/clang or specify path with --cc=PATH"
    fi

    CC_PATH="$(command -v "$CC")"
    print_status "OK" "Found CC: ${CC_PATH}"

    CC_VERSION=$($CC --version 2>/dev/null | head -n1 || echo "unknown")
    print_status "OK" "Version: ${CC_VERSION}"

    # Test compilation
    echo "int main(void) { return 0; }" > /tmp/test_$$.c
    if $CC /tmp/test_$$.c -o /tmp/test_$$ 2>/dev/null; then
        print_status "OK" "Compiler test passed"
        rm -f /tmp/test_$$.c /tmp/test_$$
    else
        rm -f /tmp/test_$$.c /tmp/test_$$
        print_status "ERROR" "Compiler test failed"
        print_error "Compiler cannot create executables"
    fi

    echo
}

# C++ Compiler Detection

detect_cxx_compiler() {
    if [ "$ENABLE_CPP" = "OFF" ]; then
        return
    fi

    print_section "Checking for C++ Compiler"

    if ! command -v "$CXX" &> /dev/null; then
        print_status "ERROR" "C++ compiler not found: $CXX"
        print_error "Please install g++/clang++ or specify path with --cxx=PATH"
    fi

    CXX_PATH="$(command -v "$CXX")"
    print_status "OK" "Found CXX: ${CXX_PATH}"

    CXX_VERSION=$($CXX --version 2>/dev/null | head -n1 || echo "unknown")
    print_status "OK" "Version: ${CXX_VERSION}"

    # Test C++ compilation
    echo "int main() { return 0; }" > /tmp/test_$$.cpp
    if $CXX /tmp/test_$$.cpp -o /tmp/test_$$ 2>/dev/null; then
        print_status "OK" "C++ compiler test passed"
        rm -f /tmp/test_$$.cpp /tmp/test_$$
    else
        rm -f /tmp/test_$$.cpp /tmp/test_$$
        print_status "ERROR" "C++ compiler test failed"
        print_error "C++ compiler cannot create executables"
    fi

    echo
}

# Archiver Detection

detect_archiver() {
    print_section "Checking for Archiver"

    if ! command -v "$AR" &> /dev/null; then
        print_status "ERROR" "Archiver not found: $AR"
        print_error "Please install binutils or specify path with --ar=PATH"
    fi

    AR_PATH="$(command -v "$AR")"
    print_status "OK" "Found AR: ${AR_PATH}"
    echo
}

# Source Files Check

check_sources() {
    print_section "Checking Source Files"

    if [ ! -d "$SRC_DIR" ]; then
        print_status "ERROR" "Source directory not found: $SRC_DIR"
        print_error "Source directory is missing"
    fi
    print_status "OK" "Source directory: ${SRC_DIR}/"

    if [ ! -d "$INC_DIR" ]; then
        print_status "ERROR" "Include directory not found: $INC_DIR"
        print_error "Include directory is missing"
    fi
    print_status "OK" "Include directory: ${INC_DIR}/"

    local c_count=$(find "$SRC_DIR" -name "*.c" 2>/dev/null | wc -l)
    print_status "INFO" "Found ${c_count} C source file(s)"

    local h_count=$(find "$INC_DIR" -name "*.h" 2>/dev/null | wc -l)
    print_status "INFO" "Found ${h_count} header file(s)"
    echo
}

# Build Flags Configuration

configure_build_flags() {
    print_section "Configuring Build Flags"

    local base_cflags="-Wall -Wextra -Wpedantic -std=c99 -I${INC_DIR} -fPIC"
    local base_cxxflags="-Wall -Wextra -Wpedantic -std=c++11 -I${INC_DIR} -fPIC"

    case "$BUILD_TYPE" in
        Release)
            CFLAGS="$base_cflags -O2"
            CXXFLAGS="$base_cxxflags -O2"
            print_status "OK" "Build type: Release (optimized)"
            ;;
        Debug)
            CFLAGS="$base_cflags -g -O0"
            CXXFLAGS="$base_cxxflags -g -O0"
            ENABLE_DEBUG="ON"
            print_status "OK" "Build type: Debug (with symbols)"
            ;;
        *)
            print_status "WARN" "Unknown build type: $BUILD_TYPE, using Release"
            CFLAGS="$base_cflags -O2"
            CXXFLAGS="$base_cxxflags -O2"
            BUILD_TYPE="Release"
            ;;
    esac

    if [ "$ENABLE_DEBUG" = "ON" ] && [ "$BUILD_TYPE" = "Release" ]; then
        CFLAGS="$CFLAGS -g"
        CXXFLAGS="$CXXFLAGS -g"
        print_status "OK" "Debug symbols: enabled"
    fi

    if [ "$ENABLE_VERBOSE" = "ON" ]; then
        print_status "OK" "Verbose output: enabled"
    fi

    print_status "INFO" "CFLAGS: ${CFLAGS}"
    if [ "$ENABLE_CPP" = "ON" ]; then
        print_status "INFO" "CXXFLAGS: ${CXXFLAGS}"
    fi
    print_status "INFO" "LDFLAGS: ${LDFLAGS}"
    echo
}

# Generate Makefile

generate_makefile() {
    print_section "Generating Makefile"

    local static_target=""
    local shared_target=""
    local all_targets=""

    if [ "$ENABLE_STATIC" = "ON" ]; then
        static_target="\$(LIB_STATIC)"
        all_targets="$all_targets \$(LIB_STATIC)"
    fi

    if [ "$ENABLE_SHARED" = "ON" ]; then
        shared_target="\$(LIB_SHARED)"
        all_targets="$all_targets \$(LIB_SHARED)"
    fi

    local verbose=""
    if [ "$ENABLE_VERBOSE" = "ON" ]; then
        verbose=""
    else
        verbose="@"
    fi

    cat > Makefile << EOF
# Makefile generated by configure on $(date)
# DO NOT EDIT - regenerate with ./configure

# Configuration
CC = $CC
CXX = $CXX
AR = $AR
CFLAGS = $CFLAGS
CXXFLAGS = $CXXFLAGS
LDFLAGS = $LDFLAGS
PREFIX = $PREFIX
LIBDIR = $LIBDIR
INCLUDEDIR = $INCLUDEDIR

# Version
VERSION = $VERSION
VERSION_MAJOR = $VERSION_MAJOR
VERSION_MINOR = $VERSION_MINOR
VERSION_PATCH = $VERSION_PATCH

# Build info
BUILD_TYPE = $BUILD_TYPE
PLATFORM = $PLATFORM
ARCH = $ARCH

# Directories
SRC_DIR = $SRC_DIR
INC_DIR = $INC_DIR
BUILD_DIR = $BUILD_DIR
LIB_DIR = $LIB_DIR
EXAMPLE_DIR = $EXAMPLE_DIR
CPP_DIR = $CPP_DIR

# Source files
SOURCES = \$(wildcard \$(SRC_DIR)/*.c)
OBJECTS = \$(SOURCES:\$(SRC_DIR)/%.c=\$(BUILD_DIR)/%.o)

# Library names
LIB_STATIC = \$(LIB_DIR)/libcsvkit.a
LIB_SHARED = \$(LIB_DIR)/libcsvkit.so
LIB_SHARED_VERSIONED = \$(LIB_DIR)/libcsvkit.so.\$(VERSION)

# C++ bindings
CPP_SOURCES = \$(wildcard \$(CPP_DIR)/*.cpp)
CPP_OBJECTS = \$(CPP_SOURCES:\$(CPP_DIR)/%.cpp=\$(BUILD_DIR)/cpp_%.o)
CPP_LIB_SHARED = \$(LIB_DIR)/libcsvkit++.so
CPP_LIB_SHARED_VERSIONED = \$(LIB_DIR)/libcsvkit++.so.\$(VERSION)

# Examples
EXAMPLE_SOURCES = \$(wildcard \$(EXAMPLE_DIR)/*.c)
EXAMPLES = \$(EXAMPLE_SOURCES:.c=)

# Default target
.PHONY: all
all:$all_targets
	@echo ""
	@echo "\033[1;32mBuild completed successfully!\033[0m"
	@echo ""
	@if [ -f "\$(LIB_STATIC)" ]; then \\
		SIZE=\$\$(du -h "\$(LIB_STATIC)" | cut -f1); \\
		echo "   \033[1mStatic library:\033[0m  \033[1;36m\$(LIB_STATIC)\033[0m (\$\$SIZE)"; \\
	fi
	@if [ -f "\$(LIB_SHARED_VERSIONED)" ]; then \\
		SIZE=\$\$(du -h "\$(LIB_SHARED_VERSIONED)" | cut -f1); \\
		echo "   \033[1mShared library:\033[0m  \033[1;36m\$(LIB_SHARED_VERSIONED)\033[0m (\$\$SIZE)"; \\
	fi
	@echo ""

# Create directories
\$(BUILD_DIR) \$(LIB_DIR):
	${verbose}mkdir -p \$@

# Compile source files
\$(BUILD_DIR)/%.o: \$(SRC_DIR)/%.c | \$(BUILD_DIR)
	@echo "\033[1m-- Compiling\033[0m \$<"
	${verbose}\$(CC) \$(CFLAGS) -c \$< -o \$@

EOF

    if [ "$ENABLE_STATIC" = "ON" ]; then
        cat >> Makefile << 'EOF'
# Build static library
$(LIB_STATIC): $(OBJECTS) | $(LIB_DIR)
	@echo ""
	@echo "\033[1m-- Creating static library\033[0m"
	@$(AR) rcs $@ $^

EOF
    fi

    if [ "$ENABLE_SHARED" = "ON" ]; then
        cat >> Makefile << 'EOF'
# Build shared library
$(LIB_SHARED): $(OBJECTS) | $(LIB_DIR)
	@echo ""
	@echo "\033[1m-- Creating shared library\033[0m"
	@$(CC) $(LDFLAGS) -Wl,-soname,libcsvkit.so.$(VERSION_MAJOR) -o $(LIB_SHARED_VERSIONED) $^
	@ln -sf libcsvkit.so.$(VERSION) $(LIB_SHARED)
	@ln -sf libcsvkit.so.$(VERSION) $(LIB_DIR)/libcsvkit.so.$(VERSION_MAJOR)

EOF
    fi

    if [ "$ENABLE_CPP" = "ON" ]; then
        cat >> Makefile << 'EOF'
# Compile C++ source files
$(BUILD_DIR)/cpp_%.o: $(CPP_DIR)/%.cpp | $(BUILD_DIR)
	@echo "\033[1m-- Compiling C++\033[0m $<"
	@$(CXX) $(CXXFLAGS) -c $< -o $@

# Build C++ shared library
.PHONY: cpp
cpp: $(CPP_LIB_SHARED)

$(CPP_LIB_SHARED): $(CPP_OBJECTS) $(LIB_SHARED) | $(LIB_DIR)
	@echo ""
	@echo "\033[1m-- Creating C++ shared library\033[0m"
	@$(CXX) $(LDFLAGS) -Wl,-soname,libcsvkit++.so.$(VERSION_MAJOR) -o $(CPP_LIB_SHARED_VERSIONED) $^ -L$(LIB_DIR) -lcsvkit
	@ln -sf libcsvkit++.so.$(VERSION) $(CPP_LIB_SHARED)
	@ln -sf libcsvkit++.so.$(VERSION) $(LIB_DIR)/libcsvkit++.so.$(VERSION_MAJOR)

EOF
    fi

    if [ "$ENABLE_EXAMPLES" = "ON" ]; then
        cat >> Makefile << 'EOF'
# Build examples
.PHONY: examples
examples: $(EXAMPLES)

$(EXAMPLE_DIR)/%: $(EXAMPLE_DIR)/%.c $(LIB_STATIC)
	@echo "\033[1m-- Building example\033[0m $@"
	@$(CC) $(CFLAGS) $< -o $@ -L$(LIB_DIR) -lcsvkit

EOF
    fi

    cat >> Makefile << 'EOF'
# Install
.PHONY: install
install: all
	@echo ""
	@echo "\033[1;36mInstalling libcsvkit\033[0m"
	@echo ""
	@echo "\033[1m-- Installing to: \033[0;36m$(PREFIX)\033[0m"
	@if [ ! -w "$(LIBDIR)" ] && [ ! -d "$(LIBDIR)" ]; then \
		echo "   \033[1;33m[WARN]\033[0m Requires root privileges"; \
		echo ""; \
		sudo install -d "$(LIBDIR)"; \
		sudo install -d "$(INCLUDEDIR)"; \
		if [ -f "$(LIB_STATIC)" ]; then sudo install -m 644 "$(LIB_STATIC)" "$(LIBDIR)/"; fi; \
		if [ -f "$(LIB_SHARED_VERSIONED)" ]; then \
			sudo install -m 755 "$(LIB_SHARED_VERSIONED)" "$(LIBDIR)/"; \
			sudo ln -sf libcsvkit.so.$(VERSION) "$(LIBDIR)/libcsvkit.so.$(VERSION_MAJOR)"; \
			sudo ln -sf libcsvkit.so.$(VERSION) "$(LIBDIR)/libcsvkit.so"; \
		fi; \
		sudo install -m 644 "$(INC_DIR)/csvkit.h" "$(INCLUDEDIR)/"; \
		sudo ldconfig 2>/dev/null || true; \
	else \
		install -d "$(LIBDIR)"; \
		install -d "$(INCLUDEDIR)"; \
		if [ -f "$(LIB_STATIC)" ]; then install -m 644 "$(LIB_STATIC)" "$(LIBDIR)/"; fi; \
		if [ -f "$(LIB_SHARED_VERSIONED)" ]; then \
			install -m 755 "$(LIB_SHARED_VERSIONED)" "$(LIBDIR)/"; \
			ln -sf libcsvkit.so.$(VERSION) "$(LIBDIR)/libcsvkit.so.$(VERSION_MAJOR)"; \
			ln -sf libcsvkit.so.$(VERSION) "$(LIBDIR)/libcsvkit.so"; \
		fi; \
		install -m 644 "$(INC_DIR)/csvkit.h" "$(INCLUDEDIR)/"; \
		ldconfig 2>/dev/null || true; \
	fi
	@echo ""
	@echo "\033[1;32mInstallation completed successfully!\033[0m"
	@echo ""
	@echo "   \033[1mHeaders:\033[0m      \033[0;36m$(INCLUDEDIR)/csvkit.h\033[0m"
	@if [ -f "$(LIBDIR)/libcsvkit.a" ]; then \
		echo "   \033[1mStatic lib:\033[0m   \033[0;36m$(LIBDIR)/libcsvkit.a\033[0m"; \
	fi
	@if [ -f "$(LIBDIR)/libcsvkit.so.$(VERSION)" ]; then \
		echo "   \033[1mShared lib:\033[0m   \033[0;36m$(LIBDIR)/libcsvkit.so.$(VERSION)\033[0m"; \
	fi
	@echo ""

EOF

    if [ "$ENABLE_CPP" = "ON" ]; then
        cat >> Makefile << 'EOF'
# Install C++ bindings
.PHONY: install-cpp
install-cpp: cpp
	@echo ""
	@echo "\033[1;36mInstalling C++ bindings\033[0m"
	@echo ""
	@if [ ! -w "$(LIBDIR)" ] && [ ! -d "$(LIBDIR)" ]; then \
		echo "   \033[1;33m[WARN]\033[0m Requires root privileges"; \
		echo ""; \
		if [ -f "$(CPP_LIB_SHARED_VERSIONED)" ]; then \
			sudo install -m 755 "$(CPP_LIB_SHARED_VERSIONED)" "$(LIBDIR)/"; \
			sudo ln -sf libcsvkit++.so.$(VERSION) "$(LIBDIR)/libcsvkit++.so.$(VERSION_MAJOR)"; \
			sudo ln -sf libcsvkit++.so.$(VERSION) "$(LIBDIR)/libcsvkit++.so"; \
		fi; \
		sudo install -m 644 "$(CPP_DIR)/csvkit.hpp" "$(INCLUDEDIR)/"; \
		sudo ldconfig 2>/dev/null || true; \
	else \
		if [ -f "$(CPP_LIB_SHARED_VERSIONED)" ]; then \
			install -m 755 "$(CPP_LIB_SHARED_VERSIONED)" "$(LIBDIR)/"; \
			ln -sf libcsvkit++.so.$(VERSION) "$(LIBDIR)/libcsvkit++.so.$(VERSION_MAJOR)"; \
			ln -sf libcsvkit++.so.$(VERSION) "$(LIBDIR)/libcsvkit++.so"; \
		fi; \
		install -m 644 "$(CPP_DIR)/csvkit.hpp" "$(INCLUDEDIR)/"; \
		ldconfig 2>/dev/null || true; \
	fi
	@echo ""
	@echo "\033[1;32mC++ bindings installed!\033[0m"
	@echo ""
	@echo "   \033[1mC++ Header:\033[0m   \033[0;36m$(INCLUDEDIR)/csvkit.hpp\033[0m"
	@if [ -f "$(LIBDIR)/libcsvkit++.so.$(VERSION)" ]; then \
		echo "   \033[1mC++ Library:\033[0m  \033[0;36m$(LIBDIR)/libcsvkit++.so.$(VERSION)\033[0m"; \
	fi
	@echo ""

EOF
    fi

    cat >> Makefile << 'EOF'
# Uninstall
.PHONY: uninstall
uninstall:
	@echo ""
	@echo "\033[1;36mUninstalling libcsvkit\033[0m"
	@echo ""
	@if [ -f "$(LIBDIR)/libcsvkit.a" ] || [ -f "$(LIBDIR)/libcsvkit.so.$(VERSION)" ]; then \
		if [ ! -w "$(LIBDIR)" ]; then \
			echo "   \033[1;33m[WARN]\033[0m Requires root privileges"; \
			echo ""; \
			sudo rm -f "$(LIBDIR)/libcsvkit.a"; \
			sudo rm -f "$(LIBDIR)/libcsvkit.so"*; \
			sudo rm -f "$(INCLUDEDIR)/csvkit.h"; \
			sudo ldconfig 2>/dev/null || true; \
		else \
			rm -f "$(LIBDIR)/libcsvkit.a"; \
			rm -f "$(LIBDIR)/libcsvkit.so"*; \
			rm -f "$(INCLUDEDIR)/csvkit.h"; \
			ldconfig 2>/dev/null || true; \
		fi; \
		echo "\033[1;32mUninstall completed!\033[0m"; \
	else \
		echo "\033[1;33m[WARN]\033[0m Library not found in $(LIBDIR)"; \
	fi
	@echo ""

EOF

    if [ "$ENABLE_CPP" = "ON" ]; then
        cat >> Makefile << 'EOF'
# Uninstall C++ bindings
.PHONY: uninstall-cpp
uninstall-cpp:
	@echo ""
	@echo "\033[1;36mUninstalling C++ bindings\033[0m"
	@echo ""
	@if [ -f "$(LIBDIR)/libcsvkit++.so.$(VERSION)" ] || [ -f "$(INCLUDEDIR)/csvkit.hpp" ]; then \
		if [ ! -w "$(LIBDIR)" ]; then \
			echo "   \033[1;33m[WARN]\033[0m Requires root privileges"; \
			echo ""; \
			sudo rm -f "$(LIBDIR)/libcsvkit++.so"*; \
			sudo rm -f "$(INCLUDEDIR)/csvkit.hpp"; \
			sudo ldconfig 2>/dev/null || true; \
		else \
			rm -f "$(LIBDIR)/libcsvkit++.so"*; \
			rm -f "$(INCLUDEDIR)/csvkit.hpp"; \
			ldconfig 2>/dev/null || true; \
		fi; \
		echo "\033[1;32mC++ bindings uninstalled!\033[0m"; \
	else \
		echo "\033[1;33m[WARN]\033[0m C++ bindings not found"; \
	fi
	@echo ""

EOF
    fi

    cat >> Makefile << 'EOF'
# Clean
.PHONY: clean
clean:
	@echo ""
	@echo "\033[1;36mCleaning libcsvkit\033[0m"
	@echo ""
	@echo "\033[1m-- Removing build artifacts\033[0m"
	@rm -rf $(BUILD_DIR) $(LIB_DIR)
	@rm -f $(EXAMPLES)
	@echo "   \033[1;32m[OK]\033[0m Removed: $(BUILD_DIR)/, $(LIB_DIR)/"
	@echo ""
	@echo "\033[1;32mClean completed!\033[0m"
	@echo ""

# Distclean
.PHONY: distclean
distclean: clean
	@echo "\033[1m-- Removing generated configuration\033[0m"
	@rm -f Makefile
	@echo "   \033[1;32m[OK]\033[0m Removed: Makefile"
	@echo ""

# Show configuration
.PHONY: config
config:
	@echo ""
	@echo "\033[1;36mBuild Configuration\033[0m"
	@echo ""
	@echo "\033[1mSystem:\033[0m"
	@echo "   \033[1mPlatform\033[0m              : \033[0;36m$(PLATFORM)\033[0m"
	@echo "   \033[1mArchitecture\033[0m          : \033[0;36m$(ARCH)\033[0m"
	@echo ""
	@echo "\033[1mCompiler:\033[0m"
	@echo "   \033[1mCC\033[0m                    : \033[0;36m$(CC)\033[0m"
	@echo "   \033[1mAR\033[0m                    : \033[0;36m$(AR)\033[0m"
	@echo "   \033[1mCFLAGS\033[0m                : \033[0;36m$(CFLAGS)\033[0m"
	@echo "   \033[1mLDFLAGS\033[0m               : \033[0;36m$(LDFLAGS)\033[0m"
	@echo ""
	@echo "\033[1mBuild:\033[0m"
	@echo "   \033[1mBuild Type\033[0m            : \033[0;36m$(BUILD_TYPE)\033[0m"
	@echo "   \033[1mVersion\033[0m               : \033[0;36m$(VERSION)\033[0m"
	@echo ""
	@echo "\033[1mDirectories:\033[0m"
	@echo "   \033[1mSource Directory\033[0m      : \033[0;36m$(SRC_DIR)\033[0m"
	@echo "   \033[1mInclude Directory\033[0m     : \033[0;36m$(INC_DIR)\033[0m"
	@echo "   \033[1mBuild Directory\033[0m       : \033[0;36m$(BUILD_DIR)\033[0m"
	@echo "   \033[1mInstall Prefix\033[0m        : \033[0;36m$(PREFIX)\033[0m"
	@echo "   \033[1mLibrary Directory\033[0m     : \033[0;36m$(LIBDIR)\033[0m"
	@echo "   \033[1mHeader Directory\033[0m      : \033[0;36m$(INCLUDEDIR)\033[0m"
	@echo ""

# Help
.PHONY: help
help:
	@echo ""
	@echo "\033[1mlibcsvkit Makefile Targets:\033[0m"
	@echo ""
	@echo "   \033[1;36mall\033[0m         Build the library (default)"
	@echo "   \033[1;36mexamples\033[0m    Build example programs"
	@echo "   \033[1;36minstall\033[0m     Install library and headers"
	@echo "   \033[1;36muninstall\033[0m   Uninstall library and headers"
	@echo "   \033[1;36mclean\033[0m       Remove build artifacts"
	@echo "   \033[1;36mdistclean\033[0m   Remove build artifacts and Makefile"
	@echo "   \033[1;36mconfig\033[0m      Show build configuration"
	@echo "   \033[1;36mhelp\033[0m        Show this help message"
	@echo ""
	@echo "To reconfigure, run: \033[1;36m./configure\033[0m"
	@echo ""

.PHONY: all install uninstall clean distclean config help
EOF

    print_status "OK" "Generated: Makefile"
    echo
}

# Print Summary

print_summary() {
    print_header "Configuration Summary"

    echo -e "${BOLD}System:${RESET}"
    print_config "Platform" "$PLATFORM"
    print_config "Architecture" "$ARCH"

    echo
    echo -e "${BOLD}Compiler:${RESET}"
    print_config "CC Path" "$CC_PATH"
    print_config "CC Version" "$CC_VERSION"
    if [ "$ENABLE_CPP" = "ON" ]; then
        print_config "CXX Path" "$CXX_PATH"
        print_config "CXX Version" "$CXX_VERSION"
    fi
    print_config "AR Path" "$AR_PATH"
    print_config "CFLAGS" "$CFLAGS"
    if [ "$ENABLE_CPP" = "ON" ]; then
        print_config "CXXFLAGS" "$CXXFLAGS"
    fi
    print_config "LDFLAGS" "$LDFLAGS"

    echo
    echo -e "${BOLD}Build Configuration:${RESET}"
    print_config "Build Type" "$BUILD_TYPE"
    print_config "Version" "$VERSION"
    print_config "Debug Symbols" "$ENABLE_DEBUG"
    print_config "Verbose Output" "$ENABLE_VERBOSE"
    print_config "Static Library" "$ENABLE_STATIC"
    print_config "Shared Library" "$ENABLE_SHARED"
    print_config "C++ Bindings" "$ENABLE_CPP"
    print_config "Examples" "$ENABLE_EXAMPLES"

    echo
    echo -e "${BOLD}Directories:${RESET}"
    print_config "Source Directory" "$SRC_DIR"
    print_config "Include Directory" "$INC_DIR"
    print_config "Build Directory" "$BUILD_DIR"
    print_config "Install Prefix" "$PREFIX"
    print_config "Library Directory" "$LIBDIR"
    print_config "Header Directory" "$INCLUDEDIR"

    echo
    echo -e "${BOLD_GREEN}Configuration completed successfully!${RESET}"
    echo
    echo -e "${BOLD}Next steps:${RESET}"
    echo -e "   ${CYAN}1.${RESET} Run ${BOLD_CYAN}make${RESET} to build the library"
    if [ "$ENABLE_CPP" = "ON" ]; then
        echo -e "   ${CYAN}2.${RESET} Run ${BOLD_CYAN}make cpp${RESET} to build C++ bindings"
        echo -e "   ${CYAN}3.${RESET} Run ${BOLD_CYAN}make examples${RESET} to build examples"
        echo -e "   ${CYAN}4.${RESET} Run ${BOLD_CYAN}make install${RESET} to install (may need sudo)"
        echo -e "   ${CYAN}5.${RESET} Run ${BOLD_CYAN}make install-cpp${RESET} to install C++ bindings"
        echo -e "   ${CYAN}6.${RESET} Run ${BOLD_CYAN}make help${RESET} to see all available targets"
    else
        echo -e "   ${CYAN}2.${RESET} Run ${BOLD_CYAN}make examples${RESET} to build examples"
        echo -e "   ${CYAN}3.${RESET} Run ${BOLD_CYAN}make install${RESET} to install (may need sudo)"
        echo -e "   ${CYAN}4.${RESET} Run ${BOLD_CYAN}make help${RESET} to see all available targets"
    fi
    echo
}

# Main Execution

main() {
    print_header "libcsvkit Configuration"

    parse_arguments "$@"
    detect_system
    detect_compiler
    detect_cxx_compiler
    detect_archiver
    check_sources
    configure_build_flags
    generate_makefile
    print_summary
}

main "$@"
